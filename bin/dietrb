#!/usr/bin/env ruby

require 'irb'

unless ARGV.empty?
  require 'optparse'
  
  OptionParser.new do |opt|
    bin = File.basename($0)
    opt.banner = "Usage:  #{bin} [options] [programfile] [arguments]"
    opt.on("-r load-lib",     "Loads the given library (same as `ruby -r')") { |lib| require lib }
    opt.on("-d",              "Set $DEBUG to true (same as `ruby -d')") { $DEBUG = true }
    opt.on("-I path",         "Add path to $LOAD_PATH") { |path| $LOAD_PATH.unshift(path) }
    opt.on("--simple-prompt", "Simple prompt mode") { IRB.formatter.prompt = :simple }
    opt.on("--noprompt",      "No prompt mode") { IRB.formatter.prompt = nil }
    opt.on("-v", "--version", "Print the version of #{bin}") do
      puts File.read(File.expand_path('../../VERSION', __FILE__))
      exit
    end
  end.parse!(ARGV)
end

IRB.formatter.filter_from_backtrace << /^#{__FILE__}/

if ARGV.empty?
  irb(self, TOPLEVEL_BINDING.dup)
else
  path = ARGV.shift
  context = IRB::Context.new(self, TOPLEVEL_BINDING.dup)
  File.open(path, 'r') do |file|
    file.each_line do |line|
      puts IRB.formatter.prompt(context) + line
      context.process_line(line)
    end
  end
end